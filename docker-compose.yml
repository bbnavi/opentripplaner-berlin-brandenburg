version: '3.7'

services:
  opentripplanner:
    environment:
      - ROUTER=bb_angermuende
      - API_URL=https://staging.api.bbnavi.de/otp/
      - DT_IMAGE=bb-navi/digitransit-ui
      - DT_TAG=next
      - GTFS_URL=https://www.vbb.de/fileadmin/user_upload/VBB/Dokumente/API-Datensaetze/gtfs-mastscharf/GTFS.zip
      - OSM_URL=https://download.geofabrik.de/europe/germany/brandenburg-latest.osm.pbf
      - GTFS_CARPOOL_URL=""
      - GRAPH_BUILD_MEMORY=10G
      - MEMORY=24G
      - OTP_PORT=8090
      - OTP_IMAGE=mfdz/opentripplanner
      - OTP_TAG=latest
      - CONFIG=bb_angermuende
      - GEOCODING_BASE_URL=https://photon.stadtnavi.eu/pelias/v1
    image: registry.gitlab.tpwd.de/tpwd/bb-navi/opentripplaner-berlin-brandenburg:staging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 15s
      timeout: 10s
      retries: 30
    networks:
      - public
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == node-002.tpwd-bb-navi
      labels:
        traefik.docker.network: public
        traefik.enable: "true"
        traefik.frontend.passHostHeader: "true"
        traefik.frontend.rule: Host:staging.api.bbnavi.de
        traefik.port: '8080'


networks:
  public:
    external: true

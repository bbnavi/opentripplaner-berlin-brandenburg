version: '3.3'
services:
  opentripplanner:
    image: ghcr.io/bbnavi/opentripplaner-berlin-brandenburg:nightly
    healthcheck:
      test:
       - CMD
       - curl
       - -f
       - http://localhost:8080/
      interval: 15s
      timeout: 10s
      retries: 30
    environment:
      API_URL: https://api.bbnavi.de/otp/
      OTP_PORT: '8090'
    networks:
     - public
    logging:
      driver: awslogs
    deploy:
      replicas: 2
      labels:
        traefik.http.routers.bbnavi-api.rule: Host(`api.bbnavi.de`)
        traefik.http.routers.bbnavi-api.tls.certresolver: acme
        traefik.http.services.bbnavi-api.loadbalancer.server.port: '8080'
        traefik.http.routers.bbnavi-api.entrypoints: https
        traefik.http.routers.bbnavi-api.tls: 'true'
        traefik.docker.network: public
        traefik.enable: 'true'
      placement:
        constraints:
         - node.role == worker
      resources:
        reservations:
          memory: 4096M
networks:
  public:
    external: true

